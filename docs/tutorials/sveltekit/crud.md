# CRUD Operations

## Adding new tasks

Now that we can see the list of tasks, it's time to add a few more.

Sveltekit enables us to accomplish the task at hand in a number of ways. Let's investigate two methods:

### 1. Using the "Conventional" Client-Side Method
Adding a Task using the conventional method involves creating a form  whose Submit event is intercepted client-side (`on:submit|preventDefault={addTask}`) and handled by the `addTask` function that invokes `taskRepo.insert()`. Remult's `insert()` method sends a **POST** request which ultimately.

Using this method, we are responsible for updating the UI - clearing the input form and updating the list of tasks.

To implement this method change your `+page.svelte` as follows:

```sveltekit
// src/routes/+page.svelte

<script lang="ts">
	import { remult } from 'remult';
	import { Task } from '../shared/Task.js';

	export let data;
	
  let tasks = data.tasks;
  let newTaskTitle = '';
	const taskRepo = remult.repo(Task);

	const addTask = async () => {
		try {
			const newTask = await taskRepo.insert({ title: newTaskTitle });
			tasks = [...tasks, newTask];
			newTaskTitle = '';
		} catch (err) {
			alert((err as { message: string }).message);
		}
	};
</script>

<svelte:head>
	<title>Remult+Sveltekit Todo App</title>
</svelte:head>

<div>
	<h1>todos</h1>
	<main>
		<form method="POST" on:submit|preventDefault={addTask}>
			<input bind:value={newTaskTitle} placeholder="What needs to be done?" />
			<button>Add</button>
		</form>

		{#each tasks as task}
			<div>
				<input type="checkbox" bind:checked={task.completed} />
				{task.title}
			</div>
		{/each}

	</main>
</div>
```
### 2. Using Form Actions

Sveltekit advocates the use of Form Actions. Using this implementation, a form is submitted to the server in regular fashion - sending a `POST` request(`FormData`) to a function in the back-end. After processing the request, the action responds back (optionally with data); and among other things, reloads the page.

When using `<form>`, client-side JavaScript is optional, but you can easily _progressively enhance_ your form interactions with JavaScript to provide the best user experience.

Remult's repository will work the same way irrespective. 

First, we remove the `addTask` function from the front-end, modify the `<form>`'s action; and remove the `on:submit` handler. We also add a special `form` variable that will contain data returned from the back-end. 

Here is our altered markup in `src/routes/+page.svelte`:

```svelte
// src/routes/+page.svelte

<script lang="ts">
	import type { Task } from "../shared/Task";
	export let data;
	const tasks:Task[] = data.tasks;
</script>

<svelte:head>
	<title>Remult+Sveltekit Todo App</title>
</svelte:head>

<div>
  <h1>todos</h1>
  <main>
    <form method="POST" action="?/addTask">
      <input name="newTaskTitle" placeholder="What needs to be done?" />
      <button>Add</button>
    </form>
    
    {#each tasks as task}
      <div>
        <input type="checkbox" bind:checked={ task.completed } />
        { task.title }
      </div>
    {/each}

  </main>
</div>
```

Then, we modify our `+page.server.ts` to add an `actions` object with our `saveTask` function which has now gone server-side:

```svelte
// src/routes/+page.server.ts

import { remult, type FindOptions } from "remult";
import { Task } from "../shared/Task";
import { fail } from "@sveltejs/kit";

const taskRepo = remult.repo(Task);

export const load = async ({ url }) => {
  // ...
};

export const actions = {
    addTask: async ({ request }) => {
        try {
            const formData = await request.formData();
            const newTaskTitle = formData.get("newTaskTitle") as string;
            const newTask = await taskRepo.insert({ title: newTaskTitle });
            return {
                success: true,
                message: 'Task added succesfully',
                newTask: structuredClone(newTask),
            };
        } catch (error) {
            return fail(400, { error: (error as { message: string }).message });
        }
    },
};
```
- Submitting the form in `+page.svelte` will call the `addTask` action in `+page.server.ts`
- The call to `taskRepo.insert` will make a post request to the Remult server which appends the new task to the repositoy - returning; in this case, a `success` status, a `message`; and the new `Task` object with all it's info (including the id generated by the database). It's upto you whether to return data or not
- Returned data can be accessed on the front-end using a special `form` variable. We use it in the example below to notify the user.

```svelte
//src/routes/+page.svelte

<script lang="ts">
	import type { Task } from "../shared/Task";
	export let data;
	export let form; // <--- receive data from form actions
	const tasks:Task[] = data.tasks;
</script>

<svelte:head>
	<title>Remult+Sveltekit Todo App</title>
</svelte:head>

<div>
	<h1>todos</h1>
	<main>
		<form method="POST" action="?/addTask">
			<input name="newTaskTitle" placeholder="What needs to be done?" />
			<button>Add</button>
		</form>

		{#if form?.success}
			<div class="alert alert-success">{form.message}</div>
		{/if}

		{#each tasks as task}
			<div>
				<input type="checkbox" bind:checked={task.completed} />
				{task.title}
			</div>
		{/each}
	</main>
</div>

```

Try adding a few tasks to see how it works.

## Delete Tasks

Let's add a _Delete_ button for each task in the list. We'll wrap each button in a form in which we will also add a hidden input with the id of the task. Clicking on the Delete button will invoke a `deleteTask` function that we will add to the `actions` object in `+page.server.ts`.

To start us off, lets edit the markup in `+page.svelte` to wrap add the Delete button:

```svelte
// src/routes/+page.svelte

// ...
<main>
  <!-- ... -->
  {#each tasks as task}
    <div>
      <h1>todos</h1>
      <div>
        <input type="checkbox" bind:checked={task.completed} />
        { task.title }
        <form method="POST" action="?/deleteTask">
          <input name="id" type="hidden" value="{task.id}" />
          <button>Delete</button>
        </form>
      </div>
    </div>
  {/each}
  </main>
</div>
```

Next, edit `+page.server.ts` and add the `deleteTask` method inside `actions`:

```svelte
export const actions = {
  addTask: async ({ request }) => {
      // ...
  },

  deleteTask: async ({ request }) => {
    try {
        const formData = await request.formData();
        const id = formData.get("id") as string;
        await taskRepo.delete(id);
        return {
            success: true,
            message: 'Task deleted succesfully'
        };
    } catch (error) {
        return fail(400, { error: (error as { message: string }).message });
    }
  },
};
```

## Modify Tasks and Mark as Completed

To make the tasks in the list updatable, we'll use an `input` element and bind it to the task's `title` property. We'll also add a _Save_ button to commit the changes to the backend database.

Here's the updated `+page.svelte`

```svelte
// src/routes/+page.svelte

<script lang="ts">
	import { enhance } from '$app/forms'; // <- use enhance

	export let data;
	export let form;
	$: tasks = data.tasks; // <- make tasks reactive
</script>

<svelte:head>
	<title>Remult+Sveltekit Todo App</title>
</svelte:head>

<div>
	<h1>todos</h1>
	<main>
		<form method="POST" action="?/addTask">
			<input name="newTaskTitle" placeholder="What needs to be done?" />
			<button>Add</button>
		</form>

		{#if form?.success}
			<div class="alert alert-success">{form.message}</div>
		{/if}

		{#each tasks as task (task.id)}
			<form method="POST" use:enhance>
				<input
					type="checkbox"
					name="completed"
					bind:checked={task.completed}
					value={task.completed}
				/>
				<input name="title" type="text" bind:value={task.title} />
				<input name="id" type="hidden" value={task.id} />
        <button formaction="?/saveTask">Save</button>
				<button formaction="?/deleteTask">Delete</button>
			</form>
		{/each}
	</main>
</div>
```
- The form has two submit buttons targeting two separate form actions
- We use `enhance` to provide [progressive enhancement](https://kit.svelte.dev/docs/form-actions#progressive-enhancement).
- We have made the `tasks` reactive so that it updated accordingly even without full page reload
- We have updated the `{#each}` loop to use `task.id` as a key for improved UI updates

Here is the correspoding action in `+page.server.ts`:

```ts
// src/routes/+page.server.ts

// ....

export const actions = {
	// ....

	saveTask: async ({ request }) => {
		const formData = await request.formData();
		const id = formData.get('id') as string;
		const title = formData.get('title') as string;
		const completed = (formData.get('completed') as unknown as boolean) || undefined;
		try {
			taskRepo.update(id, { title, completed });
			return {
				success: true,
				message: 'Task updated succesfully'
			};
		} catch (error) {
			return fail(400, { error: (error as { message: string }).message });
		}
	}
}
```

::: tip
You may have to restart the Dev Server, and refresh your browser for these effects to take effect.
:::